<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ä¸‹åŸæ¢é™©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 10px;
            user-select: none;
        }
        h1 { color: #f1c40f; font-size: 1.5rem; margin-bottom: 8px; text-shadow: 0 0 20px rgba(241,196,15,0.5); }

        .top-bar { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; justify-content: center; }
        .stat-box {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            padding: 6px 12px;
            border-radius: 20px;
            color: #fff;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #34495e;
        }
        .stat-box.gold { background: linear-gradient(135deg, #f39c12, #d68910); }
        .stat-box.floor { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .main-area { display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap; justify-content: center; }

        .battle-scene {
            position: relative;
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 50px rgba(155,89,182,0.1);
        }
        #gameCanvas { display: block; }

        .flash { position: absolute; top:0;left:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none; }
        .flash.damage { animation: flashRed 0.3s; }
        .flash.attack { animation: flashWhite 0.2s; }
        @keyframes flashRed { 0%{opacity:0.6} 100%{opacity:0} }
        @keyframes flashWhite { 0%{opacity:0.4} 100%{opacity:0} }

        .side-panel { display: flex; flex-direction: column; gap: 8px; max-width: 160px; }

        .player-card {
            background: linear-gradient(135deg, #2980b9, #1a5276);
            border-radius: 12px;
            padding: 10px;
            color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .player-card h3 { font-size: 0.9rem; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .hp-bar-container { background: #1a1a2e; border-radius: 10px; height: 12px; overflow: hidden; margin-bottom: 6px; }
        .hp-bar { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); transition: width 0.3s; border-radius: 10px; }
        .player-stats { font-size: 0.75rem; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .stat-row { display: flex; align-items: center; gap: 3px; }

        .enemy-card {
            background: linear-gradient(135deg, #6c1e1e, #4a1414);
            border-radius: 12px;
            padding: 10px;
            color: #fff;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .enemy-card.show { display: block; animation: slideIn 0.3s; }
        @keyframes slideIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
        .enemy-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .enemy-emoji { font-size: 1.8rem; }
        .enemy-info h4 { font-size: 0.9rem; }
        .enemy-hp-bar { background: #1a1a2e; border-radius: 8px; height: 8px; overflow: hidden; }
        .enemy-hp { height: 100%; background: linear-gradient(90deg, #e74c3c, #c0392b); transition: width 0.3s; }

        .action-panel { display: flex; flex-direction: column; gap: 6px; }
        .action-btn {
            padding: 10px 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn:hover { transform: scale(1.03); filter: brightness(1.1); }
        .action-btn:active { transform: scale(0.98); }
        .attack-btn { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; box-shadow: 0 4px 15px rgba(231,76,60,0.4); }
        .skill-btn { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: #fff; box-shadow: 0 4px 15px rgba(155,89,182,0.4); }
        .item-btn { background: linear-gradient(135deg, #27ae60, #1e8449); color: #fff; box-shadow: 0 4px 15px rgba(39,174,96,0.4); }
        .shop-btn { background: linear-gradient(135deg, #f39c12, #d68910); color: #fff; box-shadow: 0 4px 15px rgba(243,156,18,0.4); }
        .run-btn { background: linear-gradient(135deg, #7f8c8d, #5d6d7e); color: #fff; }

        .skill-panel {
            display: none;
            background: #1a1a2e;
            border-radius: 10px;
            padding: 8px;
            gap: 5px;
        }
        .skill-panel.show { display: flex; flex-wrap: wrap; }
        .skill-btn-small {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            background: #2c3e50;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .skill-btn-small:hover { background: #34495e; }
        .skill-btn-small.disabled { opacity: 0.5; cursor: not-allowed; }

        .log-box {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 8px;
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.7rem;
            color: #aaa;
            width: 100%;
            max-width: 320px;
        }
        .log-entry { margin: 3px 0; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-entry.damage { color: #e74c3c; }
        .log-entry.heal { color: #2ecc71; }
        .log-entry.gold { color: #f1c40f; }
        .log-entry.skill { color: #9b59b6; }
        .log-entry.event { color: #3498db; }
        .log-entry.boss { color: #e74c3c; font-weight: bold; }

        /* å•†åº—å¼¹çª— */
        .modal-overlay {
            position: fixed; top:0;left:0;width:100%;height:100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-overlay.show { display: flex; }
        .shop-modal {
            background: linear-gradient(135deg, #2c3e50, #1a252f);
            border-radius: 20px;
            padding: 20px;
            max-width: 350px;
            width: 90%;
            color: #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .shop-modal h2 { text-align: center; margin-bottom: 15px; color: #f1c40f; }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .shop-item-info { display: flex; align-items: center; gap: 10px; }
        .shop-item-emoji { font-size: 1.5rem; }
        .shop-item-name { font-weight: bold; }
        .shop-item-desc { font-size: 0.7rem; color: #aaa; }
        .buy-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background: #27ae60;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }
        .buy-btn:disabled { background: #555; cursor: not-allowed; }
        .close-shop {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 25px;
            background: #e74c3c;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        /* äº‹ä»¶å¼¹çª— */
        .event-modal .shop-modal { border: 2px solid #3498db; }
    </style>
</head>
<body>
    <h1>âš”ï¸ åœ°ä¸‹åŸæ¢é™©</h1>

    <div class="top-bar">
        <div class="stat-box floor">ğŸ° ç¬¬ <span id="floor">1</span> å±‚</div>
        <div class="stat-box gold">ğŸ’° <span id="money">0</span></div>
        <div class="stat-box">âš—ï¸ è¯æ°´ <span id="potions">2</span></div>
    </div>

    <div class="main-area">
        <div class="battle-scene">
            <canvas id="gameCanvas" width="260" height="300"></canvas>
            <div class="flash" id="flash"></div>
        </div>

        <div class="side-panel">
            <div class="player-card">
                <h3>ğŸ§™ å‹‡è€…</h3>
                <div class="hp-bar-container">
                    <div class="hp-bar" id="hpBar" style="width:100%"></div>
                </div>
                <div style="text-align:center;margin-bottom:6px;font-size:0.8rem;">
                    â¤ï¸ <span id="hp">100</span>/<span id="maxHp">100</span>
                </div>
                <div class="player-stats">
                    <div class="stat-row">âš”ï¸ <span id="attack">10</span></div>
                    <div class="stat-row">ğŸ›¡ï¸ <span id="defense">0</span></div>
                    <div class="stat-row">ğŸ—¡ï¸ <span id="weapon">æœ¨å‰‘</span></div>
                    <div class="stat-row">ğŸ›¡ï¸ <span id="armor">å¸ƒè¡£</span></div>
                </div>
            </div>

            <div class="enemy-card" id="enemyCard">
                <div class="enemy-header">
                    <div class="enemy-emoji" id="enemyEmoji">ğŸŸ¢</div>
                    <div class="enemy-info">
                        <h4 id="enemyName">å²è±å§†</h4>
                        <div class="enemy-hp-bar"><div class="enemy-hp" id="enemyHpBar" style="width:100%"></div></div>
                        <div style="font-size:0.7rem;">â¤ï¸ <span id="enemyHp">30</span>/<span id="enemyMaxHp">30</span></div>
                    </div>
                </div>
            </div>

            <div class="action-panel" id="actionPanel">
                <button class="action-btn attack-btn" onclick="attack()">âš”ï¸ æ”»å‡»</button>
                <button class="action-btn skill-btn" onclick="toggleSkills()">âœ¨ æŠ€èƒ½</button>
                <button class="action-btn item-btn" onclick="usePotion()">ğŸ§ª è¯æ°´</button>
                <button class="action-btn shop-btn" onclick="openShop()">ğŸª å•†åº—</button>
                <button class="action-btn run-btn" onclick="tryRun()">ğŸƒ é€ƒè·‘</button>
            </div>

            <div class="skill-panel" id="skillPanel">
                <button class="skill-btn-small" onclick="useSkill('fire')">ğŸ”¥ ç«çƒæœ¯ 15 MP</button>
                <button class="skill-btn-small" onclick="useSkill('ice')">â„ï¸ å†°å†» 20 MP</button>
                <button class="skill-btn-small" onclick="useSkill('heal')">ğŸ’š æ²»æ„ˆ 25 MP</button>
                <button class="skill-btn-small" onclick="useSkill('shield')">ğŸ›¡ï¸ æŠ¤ç›¾ 30 MP</button>
            </div>
        </div>
    </div>

    <div class="log-box" id="log"></div>

    <!-- å•†åº—å¼¹çª— -->
    <div class="modal-overlay" id="shopModal">
        <div class="shop-modal">
            <h2>ğŸª è£…å¤‡å•†åº—</h2>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-emoji">ğŸ—¡ï¸</div>
                    <div>
                        <div class="shop-item-name">é“å‰‘ (+5æ”»å‡»)</div>
                        <div class="shop-item-desc">éœ€è¦100é‡‘å¸</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="buyItem('weapon')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-emoji">ğŸ›¡ï¸</div>
                    <div>
                        <div class="shop-item-name">çš®ç”² (+3é˜²å¾¡)</div>
                        <div class="shop-item-desc">éœ€è¦80é‡‘å¸</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="buyItem('armor')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-emoji">âš—ï¸</div>
                    <div>
                        <div class="shop-item-name">è¯æ°´ x3</div>
                        <div class="shop-item-desc">éœ€è¦30é‡‘å¸</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="buyItem('potion')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div class="shop-item-info">
                    <div class="shop-item-emoji">â¤ï¸</div>
                    <div>
                        <div class="shop-item-name">ç”Ÿå‘½ä¹‹å¿ƒ</div>
                        <div class="shop-item-desc">+30æœ€å¤§HP (50é‡‘)</div>
                    </div>
                </div>
                <button class="buy-btn" onclick="buyItem('maxhp')">è´­ä¹°</button>
            </div>
            <button class="close-shop" onclick="closeShop()">å…³é—­å•†åº—</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // æ•Œäººæ•°æ®
        const enemies = [
            {emoji:'ğŸŸ¢',name:'å²è±å§†',hp:30,attack:5,reward:10,desc:'Qå¼¹çš„å°æ€ªç‰©'},
            {emoji:'ğŸ¦‡',name:'è™è ',hp:25,attack:8,reward:15,desc:'ä¼šå¸è¡€çš„è™è '},
            {emoji:'ğŸ•·ï¸',name:'èœ˜è››',hp:40,attack:10,reward:20,desc:'æœ‰æ¯’çš„èœ˜è››'},
            {emoji:'ğŸ',name:'æ¯’è›‡',hp:35,attack:12,reward:25,desc:'å‰§æ¯’çš„è›‡'},
            {emoji:'ğŸ’€',name:'éª·é«…',hp:50,attack:15,reward:30,desc:'äº¡çµçš„æˆ˜å£«'},
            {emoji:'ğŸ§Ÿ',name:'åƒµå°¸',hp:60,attack:12,reward:35,desc:'ä¸æ­»çš„æ€ªç‰©'}
        ];

        // Bossæ•°æ®
        const bosses = [
            {emoji:'ğŸ‘¹',name:'ç‰›å¤´äººé¦–é¢†',hp:200,attack:25,reward:200,desc:'ç‰›å¤´äººä¸€æ—çš„é¦–é¢†'},
            {emoji:'ğŸ§™',name:'é»‘æš—æ³•å¸ˆ',hp:300,attack:35,reward:300,desc:'æŒæ¡é»‘æš—é­”æ³•çš„æ³•å¸ˆ'},
            {emoji:'ğŸ‰',name:'è¿œå¤å·¨é¾™',hp:500,attack:50,reward:500,desc:'ç»Ÿæ²»åœ°ä¸‹åŸçš„å·¨é¾™'}
        ];

        // è£…å¤‡æ•°æ®
        const weapons = [
            {name:'æœ¨å‰‘',attack:0,cost:0},
            {name:'é“å‰‘',attack:5,cost:100},
            {name:'é’¢å‰‘',attack:10,cost:300},
            {name:'é­”æ³•å‰‘',attack:18,cost:600},
            {name:'ç¥å™¨',attack:30,cost:1500}
        ];
        const armors = [
            {name:'å¸ƒè¡£',defense:0,cost:0},
            {name:'çš®ç”²',defense:3,cost:80},
            {name:'é”ç”²',defense:7,cost:250},
            {name:'æ¿ç”²',defense:12,cost:500},
            {name:'ç¥å™¨',defense:20,cost:1200}
        ];

        // éšæœºäº‹ä»¶
        const events = [
            {type:'chest',emoji:'ğŸ“¦',name:'å®ç®±',desc:'å‘ç°ä¸€ä¸ªå®ç®±ï¼',action:()=>{
                const gold = Math.floor(Math.random()*30)+10;
                player.money += gold;
                log(`æ‰“å¼€å®ç®±ï¼Œè·å¾— ${gold} é‡‘å¸ï¼`,'gold');
            }},
            {type:'heal',emoji:'ğŸ’–',name:'çˆ±å¿ƒ',desc:'å‘ç°æ¢å¤ç‚¹ï¼',action:()=>{
                const heal = Math.floor(player.maxHp * 0.3);
                player.hp = Math.min(player.maxHp, player.hp + heal);
                log(`æ¢å¤ ${heal} ç‚¹ç”Ÿå‘½å€¼ï¼`,'heal');
            }},
            {type:'trap',emoji:'ğŸ’€',name:'é™·é˜±',desc:'è¸©åˆ°é™·é˜±äº†ï¼',action:()=>{
                const dmg = Math.floor(Math.random()*15)+5;
                player.hp -= dmg;
                log(`å—åˆ°é™·é˜±ä¼¤å®³ ${dmg} ç‚¹ï¼`,'damage');
                if(player.hp <= 0) gameOver();
            }},
            {type:'merchant',emoji:'ğŸ§™â€â™‚ï¸',name:'å•†äºº',desc:'ç¥ç§˜çš„å•†äººå‡ºå”®ç‰©å“',action:()=>{
                player.money += 50;
                log('å•†äººé€äº†ä½ 50é‡‘å¸ï¼','gold');
            }}
        ];

        let player = {
            hp:100, maxHp:100, attack:10, defense:0,
            money:0, potions:2, floor:1,
            weaponLevel:0, armorLevel:0,
            mp:50, maxMp:50, shield:0
        };
        let enemy = null;
        let isBoss = false;
        let inEvent = false;
        let battleState = 'searching'; // searching, battle, victory, gameover

        function draw(){
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // èƒŒæ™¯ - åœ°ä¸‹åŸé£æ ¼
            const gradient = ctx.createLinearGradient(0,0,0,canvas.height);
            gradient.addColorStop(0,'#1a1a2e');
            gradient.addColorStop(1,'#0a0a15');
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,canvas.width,canvas.height);

            // åœ°æ¿ç –å—
            ctx.fillStyle = '#151525';
            for(let y=0;y<8;y++){
                for(let x=0;x<7;x++){
                    if((x+y)%2===0){
                        ctx.fillRect(x*38,y*38,38,38);
                    }
                }
            }

            // èƒŒæ™¯è£…é¥° - èœ¡çƒ›
            ctx.font = '1.5rem';
            ctx.textAlign = 'left';
            ctx.fillText('ğŸ•¯ï¸', 10, 40);
            ctx.textAlign = 'right';
            ctx.fillText('ğŸ•¯ï¸', 250, 40);

            // æ¥¼å±‚æ•°å­—èƒŒæ™¯
            ctx.font = '6rem';
            ctx.textAlign = 'center';
            ctx.fillStyle = 'rgba(255,255,255,0.03)';
            ctx.fillText(player.floor, 130, 200);

            if(battleState === 'battle' && enemy){
                // æ•Œäºº
                ctx.font = '4rem';
                ctx.textAlign = 'center';
                const bobY = Math.sin(Date.now()/200) * 5;
                ctx.fillText(enemy.emoji, 130, 100 + bobY);

                // æ•Œäººè¡€æ¡
                const hpPercent = enemy.hp / enemy.maxHp;
                ctx.fillStyle = '#333';
                ctx.fillRect(50, 130, 160, 12);
                ctx.fillStyle = hpPercent > 0.3 ? '#e74c3c' : '#c0392b';
                ctx.fillRect(50, 130, 160 * hpPercent, 12);

                // ç©å®¶
                ctx.font = '4rem';
                ctx.fillText('ğŸ§™', 130, 220);

                // ç©å®¶è¡€æ¡
                const pHpPercent = player.hp / player.maxHp;
                ctx.fillStyle = '#333';
                ctx.fillRect(50, 250, 160, 10);
                ctx.fillStyle = pHpPercent > 0.3 ? '#27ae60' : '#e74c3c';
                ctx.fillRect(50, 250, 160 * pHpPercent, 10);

                // æŠ¤ç›¾æ•ˆæœ
                if(player.shield > 0){
                    ctx.font = '1.5rem';
                    ctx.fillText('ğŸ›¡ï¸', 180, 220);
                }

                // MPæ¡
                ctx.fillStyle = '#333';
                ctx.fillRect(50, 265, 160, 6);
                ctx.fillStyle = '#3498db';
                ctx.fillRect(50, 265, 160 * (player.mp / player.maxMp), 6);
            }else if(battleState === 'searching'){
                ctx.font = '1.5rem';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#aaa';
                ctx.fillText('ğŸ” æ¢ç´¢ä¸­...', 130, 150);
                ctx.font = '4rem';
                ctx.fillText('ğŸ§™', 130, 220);
            }else if(battleState === 'victory'){
                ctx.font = '3rem';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ†', 130, 130);
                ctx.font = '1.2rem';
                ctx.fillStyle = '#f1c40f';
                ctx.fillText('æˆ˜æ–—èƒœåˆ©!', 130, 180);
                ctx.fillStyle = '#aaa';
                ctx.font = '1rem';
                ctx.fillText('ç‚¹å‡»ç»§ç»­æ¢ç´¢...', 130, 220);
            }

            requestAnimationFrame(draw);
        }

        function spawnEnemy(){
            isBoss = (player.floor % 5 === 0);
            if(isBoss){
                const bossIndex = Math.floor((player.floor-1)/5);
                enemy = {...bosses[Math.min(bossIndex, bosses.length-1)]};
                log(`âš ï¸ é‡åˆ°BOSS ${enemy.emoji}${enemy.name}ï¼`,'boss');
            }else{
                const index = Math.floor(Math.random() * enemies.length);
                enemy = {...enemies[index]};
                log(`é‡åˆ° ${enemy.emoji}${enemy.name}ï¼`,'event');
            }
            enemy.maxHp = enemy.hp;
            updateEnemyUI();
            battleState = 'battle';
            document.getElementById('enemyCard').classList.add('show');
            flash('attack');
        }

        function spawnEvent(){
            const event = events[Math.floor(Math.random() * events.length)];
            inEvent = true;
            log(`${event.emoji} ${event.name}: ${event.desc}`,'event');
            event.action();
            inEvent = false;
            setTimeout(() => {
                player.floor++;
                updatePlayerUI();
                spawnEnemy();
            }, 1000);
        }

        function attack(){
            if(battleState !== 'battle' || !enemy) return;

            const damage = Math.max(1, player.attack + Math.floor(Math.random()*5));
            enemy.hp -= damage;
            log(`âš”ï¸ æ”»å‡»ï¼å¯¹ ${enemy.name} é€ æˆ ${damage} ä¼¤å®³`);

            // æ”»å‡»åŠ¨ç”»
            flash('attack');

            if(enemy.hp <= 0){
                winBattle();
            }else{
                setTimeout(enemyAttack, 400);
            }
            updateEnemyUI();
        }

        function enemyAttack(){
            if(!enemy || player.hp <= 0) return;

            let damage = Math.max(1, enemy.attack - player.defense);
            if(player.shield > 0){
                const blocked = Math.min(damage, player.shield);
                player.shield -= blocked;
                damage -= blocked;
                if(damage > 0) log(`æŠ¤ç›¾æŠµæ¶ˆäº† ${blocked} ä¼¤å®³ï¼`);
            }
            player.hp -= damage;
            log(`${enemy.name} æ”»å‡»ï¼å—åˆ° ${damage} ä¼¤å®³`,'damage');
            flash('damage');

            if(player.hp <= 0){
                gameOver();
            }
            updatePlayerUI();
        }

        function useSkill(skill){
            if(battleState !== 'battle' || !enemy) return;

            const costs = {fire:15, ice:20, heal:25, shield:30};
            if(player.mp < costs[skill]){
                log('é­”æ³•å€¼ä¸è¶³ï¼','damage');
                return;
            }
            player.mp -= costs[skill];

            switch(skill){
                case 'fire':
                    const fireDmg = 25 + Math.floor(Math.random()*15);
                    enemy.hp -= fireDmg;
                    log(`ğŸ”¥ ç«çƒæœ¯ï¼å¯¹ ${enemy.name} é€ æˆ ${fireDmg} ä¼¤å®³`,'skill');
                    flash('attack');
                    break;
                case 'ice':
                    enemy.attack = Math.max(1, enemy.attack - 5);
                    log(`â„ï¸ å†°å†»æœ¯ï¼${enemy.name} æ”»å‡»åŠ›ä¸‹é™ï¼`,'skill');
                    break;
                case 'heal':
                    const heal = 30 + Math.floor(Math.random()*20);
                    player.hp = Math.min(player.maxHp, player.hp + heal);
                    log(`ğŸ’š æ²»æ„ˆæœ¯ï¼æ¢å¤ ${heal} ç”Ÿå‘½å€¼`,'heal');
                    break;
                case 'shield':
                    player.shield = 20;
                    log(`ğŸ›¡ï¸ æŠ¤ç›¾æœ¯ï¼è·å¾—20ç‚¹æŠ¤ç›¾`,'skill');
                    break;
            }

            if(enemy && enemy.hp > 0){
                setTimeout(enemyAttack, 400);
            }else if(enemy && enemy.hp <= 0){
                winBattle();
            }
            updateEnemyUI();
            updatePlayerUI();
        }

        function toggleSkills(){
            const panel = document.getElementById('skillPanel');
            panel.classList.toggle('show');
        }

        function usePotion(){
            if(player.potions <= 0){
                log('æ²¡æœ‰è¯æ°´äº†ï¼å»å•†åº—è´­ä¹°å§','damage');
                return;
            }
            if(player.hp >= player.maxHp){
                log('ç”Ÿå‘½å€¼å·²æ»¡ï¼','event');
                return;
            }
            player.potions--;
            const heal = 50;
            player.hp = Math.min(player.maxHp, player.hp + heal);
            log(`ğŸ§ª ä½¿ç”¨è¯æ°´ï¼Œæ¢å¤ ${heal} ç”Ÿå‘½ï¼`,'heal');

            if(battleState === 'battle' && enemy){
                setTimeout(enemyAttack, 400);
            }
            updatePlayerUI();
        }

        function tryRun(){
            if(battleState !== 'battle'){
                // æ¢ç´¢ä¸­ç›´æ¥è¿›å…¥ä¸‹ä¸€å±‚
                if(Math.random() < 0.5){
                    log('é‡åˆ°æ€ªç‰©ï¼','event');
                    spawnEnemy();
                }else{
                    spawnEvent();
                }
                return;
            }

            if(Math.random() < 0.6){
                log('ğŸƒ é€ƒè·‘æˆåŠŸï¼','event');
                enemy = null;
                battleState = 'searching';
                document.getElementById('enemyCard').classList.remove('show');
                setTimeout(() => {
                    if(Math.random() < 0.5){
                        spawnEvent();
                    }else{
                        player.floor++;
                        updatePlayerUI();
                        spawnEnemy();
                    }
                }, 800);
            }else{
                log('ğŸƒ é€ƒè·‘å¤±è´¥ï¼','damage');
                enemyAttack();
            }
        }

        function winBattle(){
            const reward = enemy.reward;
            player.money += reward;
            log(`ğŸ‰ æˆ˜èƒœ ${enemy.name}ï¼è·å¾— ${reward} é‡‘å¸`,'gold');

            // æ¢å¤
            const mpRegen = 10;
            player.mp = Math.min(player.maxMp, player.mp + mpRegen);

            // æ¯3å±‚å®Œå…¨æ¢å¤
            if(player.floor % 3 === 0){
                player.hp = player.maxHp;
                log('ğŸ’– æ¯3å±‚æ¢å¤å…¨éƒ¨ç”Ÿå‘½ï¼','heal');
            }

            enemy = null;
            battleState = 'victory';
            document.getElementById('enemyCard').classList.remove('show');
            updatePlayerUI();
        }

        function gameOver(){
            log('ğŸ’€ ä½ å·²é˜µäº¡...','damage');
            alert(`æ¸¸æˆç»“æŸï¼\n\nä½ åˆ°è¾¾äº†ç¬¬ ${player.floor} å±‚\nç´¯è®¡è·å¾—é‡‘å¸: ${player.money}\næ­¦å™¨: ${weapons[player.weaponLevel].name}\né˜²å…·: ${armors[player.armorLevel].name}`);

            // é‡ç½®
            player.hp = player.maxHp;
            player.mp = player.maxMp;
            player.floor = 1;
            player.potions = 2;
            player.money = 0;
            player.weaponLevel = 0;
            player.armorLevel = 0;
            player.attack = 10;
            player.defense = 0;
            player.shield = 0;
            enemy = null;
            battleState = 'searching';
            document.getElementById('enemyCard').classList.remove('show');
            document.getElementById('skillPanel').classList.remove('show');
            document.getElementById('log').innerHTML = '';
            updatePlayerUI();
            spawnEnemy();
        }

        function updatePlayerUI(){
            document.getElementById('floor').textContent = player.floor;
            document.getElementById('money').textContent = player.money;
            document.getElementById('potions').textContent = player.potions;
            document.getElementById('hp').textContent = Math.max(0, player.hp);
            document.getElementById('maxHp').textContent = player.maxHp;
            document.getElementById('hpBar').style.width = (Math.max(0, player.hp)/player.maxHp*100)+'%';
            document.getElementById('attack').textContent = player.attack;
            document.getElementById('defense').textContent = player.defense;
            document.getElementById('weapon').textContent = weapons[player.weaponLevel].name;
            document.getElementById('armor').textContent = armors[player.armorLevel].name;
        }

        function updateEnemyUI(){
            if(!enemy) return;
            document.getElementById('enemyEmoji').textContent = enemy.emoji;
            document.getElementById('enemyName').textContent = enemy.name;
            document.getElementById('enemyHp').textContent = Math.max(0, enemy.hp);
            document.getElementById('enemyMaxHp').textContent = enemy.maxHp;
            document.getElementById('enemyHpBar').style.width = (Math.max(0, enemy.hp)/enemy.maxHp*100)+'%';
        }

        function log(msg, type=''){
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = msg;
            logDiv.insertBefore(entry, logDiv.firstChild);
            while(logDiv.children.length > 15) logDiv.removeChild(logDiv.lastChild);
        }

        function flash(type){
            const flashEl = document.getElementById('flash');
            flashEl.className = 'flash ' + type;
            setTimeout(() => flashEl.className = 'flash', 300);
        }

        // å•†åº—åŠŸèƒ½
        function openShop(){
            document.getElementById('shopModal').classList.add('show');
        }

        function closeShop(){
            document.getElementById('shopModal').classList.remove('show');
        }

        function buyItem(item){
            switch(item){
                case 'weapon':
                    if(player.weaponLevel >= weapons.length-1){
                        log('æ­¦å™¨å·²æ»¡çº§ï¼','event');
                        return;
                    }
                    const wCost = weapons[player.weaponLevel+1].cost;
                    if(player.money < wCost){
                        log('é‡‘å¸ä¸è¶³ï¼','damage');
                        return;
                    }
                    player.money -= wCost;
                    player.weaponLevel++;
                    player.attack = 10 + weapons[player.weaponLevel].attack;
                    log(`ğŸ—¡ï¸ è´­ä¹°äº† ${weapons[player.weaponLevel].name}ï¼`,'gold');
                    break;
                case 'armor':
                    if(player.armorLevel >= armors.length-1){
                        log('é˜²å…·å·²æ»¡çº§ï¼','event');
                        return;
                    }
                    const aCost = armors[player.armorLevel+1].cost;
                    if(player.money < aCost){
                        log('é‡‘å¸ä¸è¶³ï¼','damage');
                        return;
                    }
                    player.money -= aCost;
                    player.armorLevel++;
                    player.defense = armors[player.armorLevel].defense;
                    log(`ğŸ›¡ï¸ è´­ä¹°äº† ${armors[player.armorLevel].name}ï¼`,'gold');
                    break;
                case 'potion':
                    if(player.money < 30){
                        log('é‡‘å¸ä¸è¶³ï¼','damage');
                        return;
                    }
                    player.money -= 30;
                    player.potions += 3;
                    log('ğŸ§ª è´­ä¹°äº†3ç“¶è¯æ°´ï¼','gold');
                    break;
                case 'maxhp':
                    if(player.money < 50){
                        log('é‡‘å¸ä¸è¶³ï¼','damage');
                        return;
                    }
                    player.money -= 50;
                    player.maxHp += 30;
                    player.hp += 30;
                    log('â¤ï¸ æœ€å¤§ç”Ÿå‘½å€¼æå‡30ï¼','heal');
                    break;
            }
            updatePlayerUI();
        }

        // ç‚¹å‡»ç»§ç»­
        canvas.addEventListener('click', () => {
            if(battleState === 'victory'){
                battleState = 'searching';
                if(Math.random() < 0.4){
                    spawnEvent();
                }else{
                    player.floor++;
                    updatePlayerUI();
                    spawnEnemy();
                }
            }
        });

        // åˆå§‹åŒ–
        updatePlayerUI();
        spawnEnemy();
        draw();
    </script>
</body>
</html>
